<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- 1. โหลด TailwindCSS และ Font ไทย (IBM Plex Sans Thai) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">
  
  <!-- 2. โหลด SweetAlert2 -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    /* ตั้งค่า Font หลักให้เป็น IBM Plex Sans Thai */
    body {
      font-family: 'IBM Plex Sans Thai', sans-serif;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-md bg-white rounded-xl shadow-2xl p-6 md:p-8 text-center">
    <!--  -->
    <h1 class="text-2xl font-bold text-blue-700 mb-2">LIFF User ID </h1>
    <p class="text-gray-600 mb-6">ดึงและบันทึก Line User ID ลง Google Sheet</p>

    <!-- สถานะการเชื่อมต่อ LIFF และผลลัพธ์ -->
    <div id="statusBox" class="p-4 rounded-lg border-2 border-dashed border-gray-300 transition duration-300">
      <div id="liffStatus" class="text-yellow-600 font-semibold">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-600 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        กำลังเชื่อมต่อ Line...
      </div>
      <div id="userDataDisplay" class="mt-4 text-left text-sm hidden">
          <p class="text-gray-700">ชื่อผู้ใช้: <span id="displayName" class="font-medium text-gray-900"></span></p>
          <p class="text-gray-700 break-all">User ID: <span id="userId" class="font-mono text-xs text-green-700"></span></p>
      </div>
    </div>

    <!-- ปุ่มบันทึกข้อมูล (ซ่อนไว้จนกว่า LIFF จะพร้อม) -->
    <button id="saveButton" disabled
            class="mt-6 w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg
                   shadow-md shadow-blue-300/50 hover:bg-blue-600 transition-all duration-300 
                   disabled:opacity-50 disabled:cursor-not-allowed">
        บันทึกข้อมูล
    </button>
  </div>

  <!-- 3. โหลด LIFF SDK (ไว้ท้ายสุดก่อน <script> หลัก) -->
  <script src="https://static.line-scdn.net/liff/2.22.2/sdk.js"></script>
  
  <script>
    // *** ต้องเปลี่ยนค่านี้: แทนที่ด้วย LIFF ID ที่คุณได้รับ ***
    const CONFIG = {
        LIFF_ID: '1657790891-40VQpd6O' 
    };
    // ******************************************************

    const statusBox = document.getElementById('statusBox');
    const liffStatus = document.getElementById('liffStatus');
    const userDataDisplay = document.getElementById('userDataDisplay');
    const saveButton = document.getElementById('saveButton');
    let currentUserData = null; // เก็บข้อมูลผู้ใช้ชั่วคราว

    /**
     * LIFF Initialization and Profile Retrieval
     */
    async function initLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        if (!liff.isLoggedIn()) {          
          liff.login(); // บังคับให้ผู้ใช้เข้าสู่ระบบ
        } else {
          const profile = await liff.getProfile();
          
          currentUserData = {
              userId: profile.userId,
              displayName: profile.displayName
          };
          
          // อัปเดต UI ด้วยข้อมูลที่ดึงมา
          document.getElementById('displayName').textContent = profile.displayName;
          document.getElementById('userId').textContent = profile.userId;
          
          userDataDisplay.classList.remove('hidden');
          
          saveButton.disabled = false; // เปิดใช้งานปุ่มบันทึก
        }
      } catch (err) {
        console.error("LIFF init error:", err);
        
      }
    }
    
    // เริ่มต้น LIFF เมื่อหน้าเว็บโหลดเสร็จ
    window.onload = initLiff;

    // Event Listener สำหรับปุ่มบันทึก
    saveButton.addEventListener('click', function() {
        if (!currentUserData) {
            Swal.fire({
                icon: 'error',
                title: 'ข้อผิดพลาด',
                text: 'ไม่สามารถดึงข้อมูล Line User ID ได้ กรุณาลองโหลดหน้านี้อีกครั้ง',
            });
            return;
        }

        // แสดง SweetAlert "กำลังโหลด"
        Swal.fire({
            title: 'กำลังบันทึกข้อมูล...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
                saveButton.disabled = true; // ปิดปุ่มระหว่างบันทึก
            }
        });

        // ส่งข้อมูลไปที่ Code.gs โดยใช้ google.script.run
        google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .saveLineData(currentUserData);
    });


    /**
     * ฟังก์ชันที่ถูกเรียกเมื่อการบันทึกสำเร็จ (จาก Code.gs)
     */
    function onSuccess(result) {
      saveButton.disabled = false;
      Swal.fire({
        icon: 'success',
        title: 'บันทึกข้อมูลสำเร็จ!',
        text: result.message,
      });
      // ไม่ต้องล้างข้อมูลในฟอร์ม เพราะนี่คือข้อมูล User ที่ดึงมา
    }

    /**
     * ฟังก์ชันที่ถูกเรียกเมื่อการบันทึกล้มเหลว
     */
    function onFailure(error) {
      saveButton.disabled = false;
      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด',
        text: error.message || 'ไม่สามารถส่งข้อมูลได้ กรุณาตรวจสอบการตั้งค่า Apps Script',
      });
    }
  </script>

</body>
</html>

